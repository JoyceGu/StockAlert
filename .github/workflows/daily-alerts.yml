name: Daily Stock Alerts

on:
  schedule:
    # Run every weekday at 4:00 PM EST (9:00 PM UTC during standard time, 8:00 PM UTC during daylight time)
    # Adjust timezone as needed - this runs after market close
    - cron: '0 21 * * 1-5'  # Monday to Friday at 9:00 PM UTC
  workflow_dispatch:  # Allow manual triggering from Actions tab

jobs:
  check-alerts:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run stock alert check
      env:
        # Alert configuration (can be customized via repository variables)
        WATCH_STOCKS: ${{ vars.WATCH_STOCKS || 'VOO,QQQ,FENY,MSFT,AAPL,GOOGL,TSLA,XOM' }}
        ALERT_THRESHOLD: ${{ vars.ALERT_THRESHOLD || '20' }}
        ALERT_PERIOD: ${{ vars.ALERT_PERIOD || '3M' }}
        
      run: |
        echo "ðŸš€ Starting daily stock alert check..."
        echo "ðŸ“… Current time: $(date)"
        echo "ðŸ“Š Watching stocks: $WATCH_STOCKS"
        echo "âš ï¸  Alert threshold: $ALERT_THRESHOLD%"
        echo "ðŸ“ˆ Period: $ALERT_PERIOD"
        echo ""
        node scripts/check-alerts.js || ALERT_EXIT_CODE=$?
        
    - name: Parse alert report
      id: parse-report
      if: always()
      run: |
        REPORT=$(node scripts/check-alerts.js 2>&1 | grep -A 1000 "---REPORT---" | grep -B 1000 "---END REPORT---" | grep -v "---REPORT---" | grep -v "---END REPORT---")
        echo "report<<EOF" >> $GITHUB_OUTPUT
        echo "$REPORT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create GitHub Issue for Alerts
      if: failure()  # Only create issue if alerts were triggered (exit code 1)
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const report = JSON.parse(`${{ steps.parse-report.outputs.report }}`);
          
          // Check if issue already exists today
          const today = new Date().toISOString().split('T')[0];
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'stock-alert'
          });
          
          const todayIssue = issues.find(issue => 
            issue.title.includes(today) || 
            issue.body.includes(today)
          );
          
          if (todayIssue) {
            console.log('Issue already exists for today, updating...');
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: todayIssue.number,
              body: report.body
            });
          } else {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: report.title,
              body: report.body,
              labels: ['stock-alert', 'automated']
            });
          }
          
    - name: Comment on PR (if triggered manually)
      if: github.event_name == 'workflow_dispatch'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const report = JSON.parse(`${{ steps.parse-report.outputs.report }}`);
          console.log('Alert Report:');
          console.log(report.body);
          
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: alert-logs-${{ github.run_number }}
        path: |
          *.log
        retention-days: 7
        if-no-files-found: ignore
